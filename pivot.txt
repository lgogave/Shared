ALTER PROCEDURE [dbo].[GetSchAdhDashboardOverall]
    @FromTable Varchar(25) = NULL,
    @Month SMALLINT = NULL,
    @Year SMALLINT = NULL,
    @LOB VARCHAR(MAX) = NULL,
    @Location VARCHAR(MAX) = NULL,
    @Superwisor VARCHAR(MAX) = NULL,
    @Agent VARCHAR(MAX) = NULL,
    @ProdStatus VARCHAR(MAX) = NULL
AS
BEGIN
    DECLARE @SQL NVARCHAR(MAX) = ''
    DECLARE @Params NVARCHAR(MAX) = N'@Month SMALLINT, @Year SMALLINT, @LOB VARCHAR(MAX), @Location VARCHAR(MAX), @Superwisor VARCHAR(MAX), @Agent VARCHAR(MAX), @ProdStatus VARCHAR(MAX)'
    
    SET @SQL = '
        DECLARE @maxDate DATETIME = (SELECT MAX([Date]) FROM [dbo].TranSchAdhWex 
            WHERE ReportMonth = @Month AND ReportYear = @Year
            AND (' + CASE WHEN @LOB IS NOT NULL THEN 'LOB IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@LOB, '',''))' ELSE '1 = 1' END + ')
            AND (' + CASE WHEN @Location IS NOT NULL THEN '[Location] IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@Location, '',''))' ELSE '1 = 1' END + ')
            AND (' + CASE WHEN @Superwisor IS NOT NULL THEN '[Supervisor] IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@Superwisor, '',''))' ELSE '1 = 1' END + ')
            AND (' + CASE WHEN @Agent IS NOT NULL THEN '[Name] IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@Agent, '',''))' ELSE '1 = 1' END + ')
            AND (' + CASE WHEN @ProdStatus IS NOT NULL THEN '[Production Status] IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@ProdStatus, '',''))' ELSE '1 = 1' END + ')
        )

        DECLARE @maxWeek DATETIME = (SELECT MAX([Week Begin]) FROM [dbo].TranSchAdhWex 
            WHERE ReportMonth = @Month AND ReportYear = @Year
            AND (' + CASE WHEN @LOB IS NOT NULL THEN 'LOB IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@LOB, '',''))' ELSE '1 = 1' END + ')
            AND (' + CASE WHEN @Location IS NOT NULL THEN '[Location] IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@Location, '',''))' ELSE '1 = 1' END + ')
            AND (' + CASE WHEN @Superwisor IS NOT NULL THEN '[Supervisor] IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@Superwisor, '',''))' ELSE '1 = 1' END + ')
            AND (' + CASE WHEN @Agent IS NOT NULL THEN '[Name] IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@Agent, '',''))' ELSE '1 = 1' END + ')
            AND (' + CASE WHEN @ProdStatus IS NOT NULL THEN '[Production Status] IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@ProdStatus, '',''))' ELSE '1 = 1' END + ')
        )

        SELECT ''Day'' AS Header, [Date], SUM(Actual_Duration) / SUM(Scheduled_Duration) * 100 AS SchAdh
        FROM [dbo].TranSchAdhWex
        WHERE [Date] = @maxDate
            AND (' + CASE WHEN @LOB IS NOT NULL THEN 'LOB IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@LOB, '',''))' ELSE '1 = 1' END + ')
            AND (' + CASE WHEN @Location IS NOT NULL THEN '[Location] IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@Location, '',''))' ELSE '1 = 1' END + ')
            AND (' + CASE WHEN @Superwisor IS NOT NULL THEN '[Supervisor] IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@Superwisor, '',''))' ELSE '1 = 1' END + ')
            AND (' + CASE WHEN @Agent IS NOT NULL THEN '[Name] IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@Agent, '',''))' ELSE '1 = 1' END + ')
            AND (' + CASE WHEN @ProdStatus IS NOT NULL THEN '[Production Status] IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@ProdStatus, '',''))' ELSE '1 = 1' END + ')
        GROUP BY [Date]
        
        UNION
        
        SELECT ''Week'' AS Header, [Week Begin] AS [Week], SUM(Actual_Duration) / SUM(Scheduled_Duration) * 100 AS SchAdh
        FROM [dbo].TranSchAdhWex
        WHERE [Week Begin] = @maxWeek
            AND (' + CASE WHEN @LOB IS NOT NULL THEN 'LOB IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@LOB, '',''))' ELSE '1 = 1' END + ')
            AND (' + CASE WHEN @Location IS NOT NULL THEN '[Location] IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@Location, '',''))' ELSE '1 = 1' END + ')
            AND (' + CASE WHEN @Superwisor IS NOT NULL THEN '[Supervisor] IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@Superwisor, '',''))' ELSE '1 = 1' END + ')
            AND (' + CASE WHEN @Agent IS NOT NULL THEN '[Name] IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@Agent, '',''))' ELSE '1 = 1' END + ')
            AND (' + CASE WHEN @ProdStatus IS NOT NULL THEN '[Production Status] IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@ProdStatus, '',''))' ELSE '1 = 1' END + ')
        GROUP BY [Week Begin]
        
        UNION
        
        SELECT ''Month'' AS Header, MAX([Date]) AS [Date], SUM(Actual_Duration) / SUM(Scheduled_Duration) * 100 AS SchAdh
        FROM [dbo].TranSchAdhWex
        WHERE ReportMonth = @Month AND ReportYear = @Year
            AND (' + CASE WHEN @LOB IS NOT NULL THEN 'LOB IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@LOB, '',''))' ELSE '1 = 1' END + ')
            AND (' + CASE WHEN @Location IS NOT NULL THEN '[Location] IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@Location, '',''))' ELSE '1 = 1' END + ')
            AND (' + CASE WHEN @Superwisor IS NOT NULL THEN '[Supervisor] IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@Superwisor, '',''))' ELSE '1 = 1' END + ')
            AND (' + CASE WHEN @Agent IS NOT NULL THEN '[Name] IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@Agent, '',''))' ELSE '1 = 1' END + ')
            AND (' + CASE WHEN @ProdStatus IS NOT NULL THEN '[Production Status] IN (SELECT CAST(Item AS NVARCHAR(MAX)) FROM dbo.SplitString(@ProdStatus, '',''))' ELSE '1 = 1' END + ')
        GROUP BY MONTH([Date])
    '
    
    EXEC sp_executesql @SQL, @Params, @Month = @Month, @Year = @Year, @LOB = @LOB, @Location = @Location, @Superwisor = @Superwisor, @Agent = @Agent, @ProdStatus = @ProdStatus
END
