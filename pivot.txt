USE [RPDB]
GO
/****** Object:  StoredProcedure [dbo].[GetSchAdhDashboardOverall]    Script Date: 10/28/2024 4:58:32 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[GetSchAdhDashboardOverall]
@FromTable Varchar(25)=NULL,
@Month SMALLINT = NULL,
@Year SMALLINT = NULL,
@LOB VARCHAR(MAX)=NULL,
@Location VARCHAR(MAX)=NULL,
@Superwisor VARCHAR(MAX)=NULL,
@Agent VARCHAR(MAX)=NULL,
@ProdStatus VARCHAR(MAX)=NULL
AS 
BEGIN

--Declare 
--@Month SMALLINT = 10,
--@Year SMALLINT = 2024,
--@LOB VARCHAR(MAX)='NAF'

   Declare @maxDate DATETIME = (SELECT MAX([Date]) FROM [dbo].TranSchAdhWex 
   WHERE ReportMonth=@Month AND ReportYear=@Year 
   AND (@LOB IS NULL OR LOB IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@LOB, ',')))
   AND (@Location IS NULL OR [Location] IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@Location, ',')))
   AND (@Superwisor IS NULL OR [Supervisor] IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@Superwisor, ',')))
   AND (@Agent IS NULL OR [Name] IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@Agent, ',')))
   AND (@ProdStatus IS NULL OR [Production Status] IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@ProdStatus, ',')))
   )
  
  
  
  Declare @maxWeek DATETIME = (SELECT MAX([Week Begin]) FROM [dbo].TranSchAdhWex 
   WHERE ReportMonth=@Month AND ReportYear=@Year 
   AND (@LOB IS NULL OR LOB IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@LOB, ',')))
   AND (@Location IS NULL OR [Location] IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@Location, ',')))
   AND (@Superwisor IS NULL OR [Supervisor] IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@Superwisor, ',')))
   AND (@Agent IS NULL OR [Name] IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@Agent, ',')))
   AND (@ProdStatus IS NULL OR [Production Status] IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@ProdStatus, ',')))
   )


	SELECT 'Day' AS Header, [Date], SUM(Actual_Duration)/Sum(Scheduled_Duration) * 100 AS SchAdh 
	FROM [dbo].TranSchAdhWex
	WHERE [Date] = @maxDate
	AND (@LOB IS NULL OR LOB IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@LOB, ',')))
	AND (@Location IS NULL OR [Location] IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@Location, ',')))
	AND (@Superwisor IS NULL OR [Supervisor] IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@Superwisor, ',')))
	AND (@Agent IS NULL OR [Name] IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@Agent, ',')))
	AND (@ProdStatus IS NULL OR [Production Status] IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@ProdStatus, ',')))
	
	
	GROUP BY [Date]
	UNION
	SELECT 'Week' AS Header, [Week Begin] as [Week], SUM(Actual_Duration)/Sum(Scheduled_Duration) * 100 AS SchAdh 
	FROM [dbo].TranSchAdhWex
	WHERE [Week Begin] = @maxWeek
	AND (@LOB IS NULL OR LOB IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@LOB, ',')))
	AND (@Location IS NULL OR [Location] IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@Location, ',')))
	AND (@Superwisor IS NULL OR [Supervisor] IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@Superwisor, ',')))
	AND (@Agent IS NULL OR [Name] IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@Agent, ',')))
	AND (@ProdStatus IS NULL OR [Production Status] IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@ProdStatus, ',')))
	GROUP BY [Week Begin]
	UNION
	SELECT 'Month' AS Header, MAX([Date]) AS [Date], SUM(Actual_Duration)/Sum(Scheduled_Duration) * 100 AS SchAdh 
	FROM [dbo].TranSchAdhWex 
	WHERE ReportMonth=@Month AND ReportYear=@Year 
	AND (@LOB IS NULL OR LOB IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@LOB, ',')))
	AND (@Location IS NULL OR [Location] IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@Location, ',')))
	AND (@Superwisor IS NULL OR [Supervisor] IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@Superwisor, ',')))
	AND (@Agent IS NULL OR [Name] IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@Agent, ',')))
	AND (@ProdStatus IS NULL OR [Production Status] IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@ProdStatus, ',')))
	GROUP BY MONTH([Date])
	
END
