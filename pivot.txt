
ALTER PROCEDURE [dbo].[GetSchAdhFrequentDefaulterAgents]
@Month SMALLINT = NULL,
@Year SMALLINT = NULL,
@LOB VARCHAR(MAX)=NULL,
@Location VARCHAR(MAX)=NULL,
@Superwisor VARCHAR(MAX)=NULL,
@Agent VARCHAR(MAX)=NULL,
@ProdStatus VARCHAR(MAX)=NULL
AS 
BEGIN
SELECT TOP 20
        EmpId,
        Name,
        COUNT(*) AS ViolationCount,
        Location,
        LOB,
        Supervisor,
        Role
    FROM 
        [dbo].TranSchAdhWex
    WHERE ReportMonth=@Month AND ReportYear=@Year  
	AND (@LOB IS NULL OR LOB IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@LOB, ',')))
	AND (@Location IS NULL OR [Location] IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@Location, ',')))
	AND (@Superwisor IS NULL OR [Supervisor] IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@Superwisor, ',')))
	AND (@Agent IS NULL OR [Name] IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@Agent, ',')))
	AND (@ProdStatus IS NULL OR [Production Status] IN (select CAST(Item AS nvarchar(max)) from dbo.SplitString(@ProdStatus, ',')))
		AND Scheduled_Duration > 0 AND
        (Actual_Duration / Scheduled_Duration * 100) < 80
    GROUP BY 
        EmpId, Name, Location, LOB, Supervisor, Role
    HAVING 
        COUNT(*) > 3 ORDER BY ViolationCount DESC
END
