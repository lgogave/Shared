CREATE PROCEDURE GetAgentDetailsForPoorAdherenceActivities
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @SQL NVARCHAR(MAX);

    SET @SQL = '
        SELECT 
            Scheduled_Activity AS Activity,
            EmpId,
            Name,
            Location,
            LOB,
            Supervisor,
            Role,
            Actual_Duration,
            Scheduled_Duration,
            (Actual_Duration / Scheduled_Duration * 100) AS AdherencePercentage
        FROM 
            ScheduleAdherence
        WHERE 
            (Actual_Duration / Scheduled_Duration * 100) < 80
            AND Scheduled_Activity IN (
                SELECT Scheduled_Activity 
                FROM ScheduleAdherence 
                WHERE (Actual_Duration / Scheduled_Duration * 100) < 80
                GROUP BY Scheduled_Activity, Location, LOB
                HAVING COUNT(DISTINCT EmpId) > 3
            )
        ORDER BY 
            Scheduled_Activity, Location, LOB;
    ';

    EXEC sp_executesql @SQL;
END




CREATE PROCEDURE GetAgentDetailsForHighAdherenceIssuesByTime
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @SQL NVARCHAR(MAX);

    SET @SQL = '
        SELECT 
            DATEPART(HOUR, Scheduled_From) AS Hour,
            EmpId,
            Name,
            Location,
            LOB,
            Supervisor,
            Role,
            Actual_Duration,
            Scheduled_Duration,
            (Actual_Duration / Scheduled_Duration * 100) AS AdherencePercentage
        FROM 
            ScheduleAdherence
        WHERE 
            (Actual_Duration / Scheduled_Duration * 100) < 80
            AND DATEPART(HOUR, Scheduled_From) IN (
                SELECT DATEPART(HOUR, Scheduled_From)
                FROM ScheduleAdherence
                WHERE (Actual_Duration / Scheduled_Duration * 100) < 80
                GROUP BY DATEPART(HOUR, Scheduled_From), Location, LOB
                HAVING COUNT(*) > 5
            )
        ORDER BY 
            Hour, Location, LOB;
    ';

    EXEC sp_executesql @SQL;
END



CREATE PROCEDURE GetAgentDetailsForLocationIssues
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @SQL NVARCHAR(MAX);

    SET @SQL = '
        SELECT 
            Location,
            LOB,
            Supervisor,
            EmpId,
            Name,
            Role,
            Actual_Duration,
            Scheduled_Duration,
            (Actual_Duration / Scheduled_Duration * 100) AS AdherencePercentage
        FROM 
            ScheduleAdherence
        WHERE 
            (Actual_Duration / Scheduled_Duration * 100) < 80
            AND Location IN (
                SELECT Location 
                FROM ScheduleAdherence 
                WHERE (Actual_Duration / Scheduled_Duration * 100) < 80
                GROUP BY Location, LOB, Supervisor
                HAVING COUNT(*) > 10
            )
        ORDER BY 
            Location, LOB, Supervisor;
    ';

    EXEC sp_executesql @SQL;
END



CREATE PROCEDURE GetAgentDetailsForInconsistentPatterns
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @SQL NVARCHAR(MAX);

    SET @SQL = '
        SELECT 
            DATEPART(WEEK, Date) AS Week,
            Location,
            LOB,
            EmpId,
            Name,
            Supervisor,
            Role,
            Actual_Duration,
            Scheduled_Duration,
            (Actual_Duration / Scheduled_Duration * 100) AS AdherencePercentage
        FROM 
            ScheduleAdherence
        WHERE 
            (Actual_Duration / Scheduled_Duration * 100) < 80
            AND DATEPART(WEEK, Date) IN (
                SELECT DATEPART(WEEK, Date) 
                FROM ScheduleAdherence 
                WHERE (Actual_Duration / Scheduled_Duration * 100) < 80
                GROUP BY DATEPART(WEEK, Date), Location, LOB
                HAVING COUNT(*) > 5 -- More than 5 violations in that week
            )
        ORDER BY 
            Week, Location, LOB;
    ';

    EXEC sp_executesql @SQL;
END
